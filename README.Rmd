---
title: "ggbarribbon"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
sigmoid <- function(x_from, x_to, y_from, y_to, n = 100, smooth = 5) {
  x <- seq(-smooth, smooth, length = n)
  y <- exp(x) / (exp(x) + 1)
  data.frame(x = (x + smooth) / (smooth * 2) * (x_to - x_from) + x_from,
             y = y * (y_to - y_from) + y_from)
}
StatBarRibbon <- ggplot2::ggproto(
  "StatBarRibbon", ggplot2::Stat,
  setup_data = function(data, params) {
    data <- data %>%
      dplyr::group_by(PANEL, group) %>%
      dplyr::mutate(x_next=lead(x), y_next=lead(y)) %>%
      filter(!is.na(x_next))
    data
  },
  compute_panel = function(data, scales) {
    out <- mapply(ggbump::sigmoid, data$x, data$x_next, data$y, data$y_next, 
                  n=abs(data$x-data$x_next)+1, SIMPLIFY = FALSE) %>%
      mapply(FUN = cbind, fill=data$fill, PANEL=data$PANEL, 
             group=data$group, SIMPLIFY = FALSE) %>%
      do.call(what = "rbind") %>%
      group_by(group, x) %>%
      slice(1) %>%
      group_by(x) %>%
      mutate(y_rel=y/sum(y)) %>%
      mutate(ymin=c(0, head(cumsum(y_rel), -1))) %>%
      mutate(ymax=cumsum(y_rel))
  },
  required_aes = c("x", "y")
)
geom_bar_ribbon <- function(mapping = NULL, data = NULL, stat = "identity",
                            position = "identity", na.rm = FALSE, show.legend = NA,
                            inherit.aes = TRUE, ...) {
  ggplot2::layer(
    stat = StatBarRibbon, data = data, mapping = mapping, geom = "ribbon",
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}
```

A small repo that implements a new geom for `ggplot2`: `geom_bar_ribbon`. This geom interpolates smoothly between the values that would normally be provided to geom_bar using a sigmoid curve.

Often, this is useful when a stacked bar plot is desired but the values along the perpindicular axis are numeric rather than discrete. A numeric axis often results in overplotting or weird spacing issues when the data could instead be interpolated and show up more nicely.

```{r}
metab_df <- data.frame(
  metab=LETTERS[1:10], 
  depth=rep(c(0, 5, 25, 125, 175), each=10),
  area=runif(50)
)
```

For example, the barplot below does a nice job of conveying changes in relative metabolite abundance over depth, but the spacing on the y axis is awful and results in a large amount of whitespace.

```{r}
ggbar <- ggplot(metab_df) +
  geom_bar(aes(y=area, x=-depth, fill=metab), stat = "identity", 
           position = position_fill(reverse = TRUE), color="black") +
  coord_flip()
ggbar
```

Instead, with geom_bar_ribbon, the data can be smoothly interpolated so that the whitespace is used and the trends between different depths are much clearer.

```{r}
ggbarribbon <- ggplot(metab_df) +
  geom_bar_ribbon(aes(y=area, x=-depth, fill=metab), color="black") +
  coord_flip()
ggbarribbon
```

A direct comparison:

```{r}
gridExtra::grid.arrange(ggbar, ggbarribbon)
```

And of course, because it's built within the ggplot2 family it's completely customizable:

```{r}
ggbarribbon +
  geom_vline(xintercept = -metab_df$depth, lwd=1) +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "top",
        text = element_text(size = 18)) +
  labs(x="Depth (m)", y="Metabolite proportion", fill="Metabolite ID") +
  scale_fill_manual(values = LaCroixColoR::lacroix_palette("Pamplemousse", type="paired", n = 10))
```


README last compiled on `r Sys.Date()`.
